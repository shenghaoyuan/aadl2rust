-- 系统功能：演示中断服务例程（ISR）与设备驱动的建模机制
--   - RTC_ISR线程：非周期性线程，模拟实时时钟的中断服务例程，产生中断事件
--   - Printer线程：偶发线程（周期1ms），响应中断事件，模拟中断处理程序

-- 系统特点：
-- 1. 专门用于演示中断服务例程和设备驱动的建模方法
-- 2. 通过非周期性线程模拟中断服务例程（ISR），通过偶发线程模拟中断处理程序
-- 3. 注释中展示了完整的设备驱动模型：设备（RTC）、设备驱动（RTC_Driver）和中断服务例程的三层架构
-- 4. 简化实现中使用了两个进程：RTC_Driver_Process（模拟驱动）和Ticker（模拟应用）
-- 5. 通过事件端口（event port）连接中断产生和处理，模拟中断信号传递

--  This model illustrates various mechanisms to attach an ISR to a device

package ISR
public
  -- with Processors;

  --  RTC models a Real-Time Clock (RTC), that is a device that
  --  periodically emits an interrupt

  -- device RTC
  -- features
  --   ISR_Out : out event port;
  -- properties
  --   Dispatch_Protocol => Periodic;
  --   Period            => 10 ms;

  --   Device_Driver => classifier (RTC_Driver.impl);
  --   --  Here, this property alone would be sufficient to attach a
  --   --  device driver, but .. if one wants to relate device features
  --   --  (port, provides subprogram access, etc) to driver components,
  --   --  one needs to duplicate this information in the device
  --   --  implementation, see below.
  -- end RTC;

  -- device implementation RTC.Impl
  -- subcomponents
  --   Driver : abstract RTC_Driver.impl;
  -- connections
  --   C1 : port Driver.ISR_out -> ISR_Out;
  -- end RTC.Impl;

  --  RTC_Driver is the device driver associated to the RTC device. It
  --  is made of an aperiodic thread that propagates the received
  --  interrupt.

  thread RTC_ISR
  features
    isr_out : out event port;
  properties
    Dispatch_Protocol => Aperiodic;
  end RTC_ISR;

  thread implementation RTC_ISR.impl
  end RTC_ISR.impl;

  -- abstract RTC_Driver
  -- features
  --   ISR_Out : out event port;
  -- end RTC_Driver;

  -- abstract implementation RTC_Driver.impl
  -- subcomponents
  --   ISR : thread RTC_ISR;
  -- connections
  --  C1: port ISR.ISR_Out -> ISR_Out;
  -- end RTC_Driver.impl;

  process RTC_Driver_Process
  features
    isr_out : out event port;
  end RTC_Driver_Process;

  process implementation RTC_Driver_Process.impl
  subcomponents
    isr : thread RTC_ISR;
  connections
    C1: port isr.isr_out -> isr_out;
  end RTC_Driver_Process.impl;

  --  This process is a dumb application that simply displays the
  --  current time, based from interrupts received from RTC component

  thread Printer
  features
    top : in event port;
  properties
    Dispatch_Protocol => Sporadic;
    Period            => 1 ms;
  end Printer;

  thread implementation Printer.impl
  end Printer.impl;

  process Ticker
  features
    isr_in: in event port;
  end Ticker;

  process implementation Ticker.impl
  subcomponents
    ticker_printer : thread Printer;
  connections
    C1: port isr_in -> ticker_printer.top;
  end Ticker.impl;

  --  System that binds them all

  processor CPU
  end CPU;

  processor implementation CPU.impl
  end CPU.impl;

  system Ticker_System
  end Ticker_System;

  system implementation Ticker_System.impl
  subcomponents
    -- CPU : processor Processors::Generic_CPU;
    cpu : processor CPU.impl;
    ticker_display : process Ticker.impl;
    -- Clock_Device   : device  RTC.impl;
    clock_driver   : process RTC_Driver_Process.impl;

  connections
  --   C1: port  Clock_Device.ISR_Out -> Ticker_Display.ISR_In;
    C1: port clock_driver.ISR_Out -> ticker_display.ISR_In;
  properties
    Actual_Processor_Binding => reference (CPU) applies to ticker_display;
    -- Actual_Processor_Binding => reference (CPU) applies to Clock_Device;
    Actual_Processor_Binding => reference (cpu) applies to clock_driver;
  end Ticker_System.impl;

end ISR;