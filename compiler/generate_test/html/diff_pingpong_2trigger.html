<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>Diff for pingpong_2trigger</title>
<style>
body {
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  background: #1e1e1e;
  color: #d4d4d4;
}
pre {
  white-space: pre-wrap;
}
.line-add    { background-color: #003800; color: #c8ffc8; }
.line-remove { background-color: #3f0001; color: #ffcccc; }
.line-header { color: #4fc1ff; font-weight: bold; }
</style>
</head>
<body>
<h2>Diff for pingpong_2trigger</h2>
<pre>
<span class="line-remove">--- original</span>
<span class="line-add">+++ modified</span>
<span class="line-header">@@ -1,5 +1,5 @@</span>
<span class="line-remove">-// 自动生成的 Rust 代码 - 来自 AADL 模型</span>
<span class="line-remove">-// 生成时间: 2025-10-14 21:06:54</span>
<span class="line-add">+// Auto-generated from AADL package: ping_local</span>
<span class="line-add">+// 生成时间: 2025-12-21 19:44:32</span>

 #![allow(unused_imports)]
 use crossbeam_channel::{Receiver, Sender};
<span class="line-header">@@ -8,6 +8,10 @@</span>
 use std::time::{Duration, Instant};
 use lazy_static::lazy_static;
 use std::collections::HashMap;
<span class="line-add">+use crate::common_traits::*;</span>
<span class="line-add">+use tokio::sync::broadcast::{self,Sender as BcSender, Receiver as BcReceiver};</span>
<span class="line-add">+use libc::{self, syscall, SYS_gettid};</span>
<span class="line-add">+use rand::{Rng};</span>
 use libc::{
     pthread_self, sched_param, pthread_setschedparam, SCHED_FIFO,
     cpu_set_t, CPU_SET, CPU_ZERO, sched_setaffinity,
<span class="line-header">@@ -24,34 +28,11 @@</span>
     }
 }

<span class="line-remove">-// ---------------- System ----------------</span>
<span class="line-remove">-pub trait System {</span>
<span class="line-remove">-    fn new() -&gt; Self</span>
<span class="line-remove">-        where Self: Sized;</span>
<span class="line-remove">-    fn run(self);</span>
<span class="line-remove">-}</span>
<span class="line-remove">-</span>
<span class="line-remove">-// ---------------- Process ----------------</span>
<span class="line-remove">-pub trait Process {</span>
<span class="line-remove">-    fn new(cpu_id: isize) -&gt; Self</span>
<span class="line-remove">-        where Self: Sized;</span>
<span class="line-remove">-    fn start(self);</span>
<span class="line-remove">-}</span>
<span class="line-remove">-</span>
<span class="line-remove">-// ---------------- Thread ----------------</span>
<span class="line-remove">-pub trait Thread {</span>
<span class="line-remove">-    fn new(cpu_id: isize) -&gt; Self</span>
<span class="line-remove">-        where Self: Sized;</span>
<span class="line-remove">-    fn run(self);</span>
<span class="line-remove">-}</span>
<span class="line-remove">-</span>
 // AADL Process: a
 #[derive(Debug)]
 pub struct aProcess {
     pub cpu_id: isize,// 进程 CPU ID
<span class="line-remove">-    #[allow(dead_code)]</span>
     pub pinger: pThread,// 子组件线程（Pinger : thread P）
<span class="line-remove">-    #[allow(dead_code)]</span>
     pub ping_me: qThread,// 子组件线程（Ping_Me : thread Q）
 }

<span class="line-header">@@ -58,30 +39,30 @@</span>
 impl Process for aProcess {
     // Creates a new process instance
     fn new(cpu_id: isize) -&gt; Self {
<span class="line-remove">-        let mut pinger: pThread = pThread::new(cpu_id);</span>
<span class="line-remove">-        let mut ping_me: qThread = qThread::new(cpu_id);</span>
<span class="line-remove">-        let channel = crossbeam_channel::unbounded();</span>
<span class="line-add">+        let pinger: pThread = pThread::new(cpu_id);</span>
<span class="line-add">+        let ping_me: qThread = qThread::new(cpu_id);</span>
<span class="line-add">+        let cnx1 = crossbeam_channel::unbounded();</span>
         // build connection: 
<span class="line-remove">-            pinger.data_source_1 = Some(channel.0);</span>
<span class="line-add">+            pinger.data_source_1 = Some(cnx1.0);</span>
         // build connection: 
<span class="line-remove">-            ping_me.data_sink_1 = Some(channel.1);</span>
<span class="line-remove">-        let channel = crossbeam_channel::unbounded();</span>
<span class="line-add">+            ping_me.data_sink_1 = Some(cnx1.1);</span>
<span class="line-add">+        let cnx2 = crossbeam_channel::unbounded();</span>
         // build connection: 
<span class="line-remove">-            pinger.data_source_2 = Some(channel.0);</span>
<span class="line-add">+            pinger.data_source_2 = Some(cnx2.0);</span>
         // build connection: 
<span class="line-remove">-            ping_me.data_sink_2 = Some(channel.1);</span>
<span class="line-add">+            ping_me.data_sink_2 = Some(cnx2.1);</span>
         return Self { pinger, ping_me, cpu_id }  //显式return;
     }
     
     // Starts all threads in the process
<span class="line-remove">-    fn start(self: Self) -&gt; () {</span>
<span class="line-add">+    fn run(self: Self) -&gt; () {</span>
         let Self { pinger, ping_me, cpu_id, .. } = self;
         thread::Builder::new()
             .name(&quot;pinger&quot;.to_string())
<span class="line-remove">-            .spawn(|| { pinger.run() }).unwrap();</span>
<span class="line-add">+            .spawn(move || { pinger.run() }).unwrap();</span>
         thread::Builder::new()
             .name(&quot;ping_me&quot;.to_string())
<span class="line-remove">-            .spawn(|| { ping_me.run() }).unwrap();</span>
<span class="line-add">+            .spawn(move || { ping_me.run() }).unwrap();</span>
     }
     
 }
<span class="line-header">@@ -89,7 +70,6 @@</span>
 // AADL System: PING
 #[derive(Debug)]
 pub struct pingSystem {
<span class="line-remove">-    #[allow(dead_code)]</span>
     pub node_a: aProcess,// 子组件进程（Node_A : process A）
 }

<span class="line-header">@@ -102,7 +82,7 @@</span>
     
     // Runs the system, starts all processes
     fn run(self: Self) -&gt; () {
<span class="line-remove">-        self.node_a.start();</span>
<span class="line-add">+        self.node_a.run();</span>
     }
     
 }
<span class="line-header">@@ -156,14 +136,14 @@</span>
     // 创建组件并初始化AADL属性
     fn new(cpu_id: isize) -&gt; Self {
         return Self {
<span class="line-add">+            dispatch_protocol: &quot;Periodic&quot;.to_string(), </span>
<span class="line-add">+            recover_entrypoint_source_text: &quot;recover&quot;.to_string(), </span>
<span class="line-add">+            priority: 2, </span>
<span class="line-add">+            deadline: 2000, </span>
             period: 2000, 
<span class="line-remove">-            data_source_2: None, </span>
             dispatch_offset: 500, 
<span class="line-remove">-            priority: 2, </span>
<span class="line-remove">-            deadline: 2000, </span>
<span class="line-add">+            data_source_2: None, </span>
             data_source_1: None, 
<span class="line-remove">-            dispatch_protocol: &quot;Periodic&quot;.to_string(), </span>
<span class="line-remove">-            recover_entrypoint_source_text: &quot;recover&quot;.to_string(), </span>
             cpu_id: cpu_id, // CPU ID
         };
     }
<span class="line-header">@@ -182,8 +162,12 @@</span>
             set_thread_affinity(self.cpu_id);
         };
         let period: std::time::Duration = Duration::from_millis(2000);
<span class="line-add">+        let mut next_release = Instant::now() + period;</span>
         loop {
<span class="line-remove">-            let start = Instant::now();</span>
<span class="line-add">+            let now = Instant::now();</span>
<span class="line-add">+            if now &lt; next_release {</span>
<span class="line-add">+                std::thread::sleep(next_release - now);</span>
<span class="line-add">+            };</span>
             {
                 // --- 调用序列（等价 AADL 的 Wrapper）---
                            // p_spg() -&gt; p_spg2();
<span class="line-header">@@ -200,8 +184,7 @@</span>
                     sender.send(val).unwrap();
                 };
             };
<span class="line-remove">-            let elapsed = start.elapsed();</span>
<span class="line-remove">-            std::thread::sleep(period.saturating_sub(elapsed));</span>
<span class="line-add">+            next_release += period;</span>
         };
     }
     
<span class="line-header">@@ -223,12 +206,12 @@</span>
     // 创建组件并初始化AADL属性
     fn new(cpu_id: isize) -&gt; Self {
         return Self {
<span class="line-remove">-            data_sink_2: None, </span>
<span class="line-remove">-            priority: 1, </span>
<span class="line-add">+            period: 10, </span>
<span class="line-add">+            dispatch_protocol: &quot;Sporadic&quot;.to_string(), </span>
             data_sink_1: None, 
<span class="line-remove">-            dispatch_protocol: &quot;Sporadic&quot;.to_string(), </span>
             deadline: 10, 
<span class="line-remove">-            period: 10, </span>
<span class="line-add">+            priority: 1, </span>
<span class="line-add">+            data_sink_2: None, </span>
             cpu_id: cpu_id, // CPU ID
         };
     }
<span class="line-header">@@ -294,7 +277,19 @@</span>
     static ref CPU_ID_TO_SCHED_POLICY: HashMap&lt;isize, i32&gt; = {
         let mut map: HashMap&lt;isize, i32&gt; = HashMap::new();
         map.insert(0, SCHED_FIFO);
<span class="line-add">+        map.insert(1, SCHED_FIFO);</span>
<span class="line-add">+        map.insert(2, SCHED_FIFO);</span>
<span class="line-add">+        map.insert(3, SCHED_FIFO);</span>
         return map;
     };
 }

<span class="line-add">+// prio(P)=max(1,min(99,99−⌊k⋅log10(P)⌋))</span>
<span class="line-add">+// 根据周期计算优先级，周期越短优先级越高</span>
<span class="line-add">+// 用于 RMS (Rate Monotonic Scheduling) 和 DMS (Deadline Monotonic Scheduling)</span>
<span class="line-add">+pub fn period_to_priority(period_ms: f64) -&gt; i32 {</span>
<span class="line-add">+    let k: f64 = 10.0;</span>
<span class="line-add">+    let raw: f64 = 99.0 - k * period_ms.log10().floor();</span>
<span class="line-add">+    return raw.max(1.0).min(99.0) as i32;</span>
<span class="line-add">+}</span>
<span class="line-add">+</span>

</pre>
</body>
</html>
